<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>義務教育9年 5教科ランダム25問クイズ（500問×5教科）</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0b1020" />

  <!-- Chart.js (Radar) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg:#0b1020; --muted:#8ea0c7; --text:#eaf0ff; --accent:#7aa7ff;
      --good:#3ddc97; --bad:#ff5c7a; --warn:#ffc857;
      --border: rgba(255,255,255,0.08);
      --shadow: 0 10px 25px rgba(0,0,0,0.35);
      --radius: 16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Hiragino Kaku Gothic ProN", Meiryo, "Noto Sans JP";
      background: radial-gradient(1200px 800px at 10% 10%, rgba(122,167,255,.18), transparent 60%),
                  radial-gradient(900px 700px at 90% 30%, rgba(61,220,151,.12), transparent 55%),
                  radial-gradient(800px 600px at 50% 90%, rgba(255,92,122,.10), transparent 55%),
                  var(--bg);
      color:var(--text);
      line-height:1.6;
    }
    header{ padding:26px 18px 10px; max-width:1180px; margin:0 auto; }
    .title{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    h1{ margin:0; font-size:22px; letter-spacing:.3px; }
    .badge{
      padding:6px 10px; border:1px solid var(--border); border-radius:999px;
      color:var(--muted); font-size:12px; backdrop-filter: blur(8px);
    }
    .sub{ margin-top:8px; color:var(--muted); font-size:14px; }

    main{
      max-width:1180px; margin:0 auto; padding:12px 18px 32px;
      display:grid; grid-template-columns: 1.35fr .65fr; gap:18px;
    }
    @media (max-width: 980px){ main{ grid-template-columns:1fr; } }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--border); border-radius: var(--radius);
      box-shadow: var(--shadow); overflow:hidden;
    }
    .card .hd{
      padding:14px 16px; border-bottom:1px solid var(--border);
      display:flex; justify-content:space-between; gap:10px; align-items:center;
    }
    .card .bd{ padding:16px; }
    .meta{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; color:var(--muted); font-size:13px; }
    .pill{ padding:6px 10px; border-radius:999px; border:1px solid var(--border); background: rgba(0,0,0,.10); }

    .btnrow{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:flex-end; }
    button{
      border:1px solid var(--border); background: rgba(255,255,255,.06); color:var(--text);
      padding:10px 12px; border-radius: 12px; cursor:pointer;
      transition: transform .04s ease, background .2s ease, border-color .2s ease;
      font-weight:700; letter-spacing:.2px;
    }
    button:hover{ background: rgba(255,255,255,.10); }
    button:active{ transform: translateY(1px); }
    button.primary{ border-color: rgba(122,167,255,.45); background: rgba(122,167,255,.18); }
    button.primary:hover{ background: rgba(122,167,255,.26); }
    button.danger{ border-color: rgba(255,92,122,.45); background: rgba(255,92,122,.12); }
    button.ghost{ background: transparent; }
    button:disabled{ opacity:.55; cursor:not-allowed; }

    .controls{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:10px;
    }
    @media (max-width: 980px){ .controls{ grid-template-columns: 1fr; } }
    .controlbox{
      border:1px solid var(--border);
      background: rgba(0,0,0,.12);
      border-radius: 14px;
      padding:12px;
    }
    .controlbox .ct{ font-weight:900; margin-bottom:8px; }
    .checks{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; color:var(--muted); font-size:13px; }
    .checks label{ display:flex; gap:8px; align-items:center; cursor:pointer; user-select:none; }
    input[type="checkbox"]{ accent-color: var(--accent); }

    .q{
      border:1px solid var(--border); border-radius: 14px; padding:14px;
      background: rgba(0,0,0,.14); margin-bottom:12px;
    }
    .qtop{ display:flex; justify-content:space-between; gap:10px; align-items:flex-start; margin-bottom:10px; }
    .qtitle{ font-weight:900; font-size:15px; }
    .qmeta{ color: var(--muted); font-size:12px; margin-top:3px; display:flex; gap:8px; flex-wrap:wrap; }
    .tag{
      font-size:12px; padding:4px 8px; border-radius:999px; border:1px solid var(--border);
      color:var(--muted); background: rgba(255,255,255,.04); user-select:none;
    }
    .tag.good{ color:#b8ffe3; border-color: rgba(61,220,151,.25); }
    .tag.bad{ color:#ffd0da; border-color: rgba(255,92,122,.25); }
    .tag.warn{ color:#ffe6b0; border-color: rgba(255,200,87,.25); }

    .choices{ display:grid; gap:8px; }
    .choice{
      display:flex; gap:10px; align-items:center;
      padding:10px 12px; border-radius: 12px; border:1px solid var(--border);
      background: rgba(255,255,255,.05); cursor:pointer; user-select:none;
      transition: background .15s ease, border-color .15s ease;
    }
    .choice:hover{ background: rgba(255,255,255,.08); }
    .choice input{ accent-color: var(--accent); }
    .choice.selected{ border-color: rgba(122,167,255,.45); background: rgba(122,167,255,.14); }
    .choice.correct{ border-color: rgba(61,220,151,.45); background: rgba(61,220,151,.12); }
    .choice.wrong{ border-color: rgba(255,92,122,.45); background: rgba(255,92,122,.12); }

    .rightcol .card{ position:sticky; top:14px; }
    @media (max-width: 980px){ .rightcol .card{ position:static; } }

    .resultgrid{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .kpi{
      border:1px solid var(--border); background: rgba(0,0,0,.12);
      border-radius: 14px; padding:12px;
    }
    .kpi .v{ font-size:22px; font-weight:900; }
    .kpi .k{ color:var(--muted); font-size:12px; margin-top:2px; }

    .analysis{
      border:1px solid var(--border); border-radius:14px; padding:12px;
      background: rgba(0,0,0,.12); color: var(--text); font-size: 13.5px;
    }
    .analysis ul{ margin:8px 0 0 18px; color: var(--muted); }
    .analysis b{ color: var(--text); }

    .numstrip{ display:flex; flex-wrap:wrap; gap:8px; }
    .numstrip button{
      width:40px; height:40px; padding:0; border-radius: 12px; font-weight:900;
    }
    .numstrip button.good{ border-color: rgba(61,220,151,.45); background: rgba(61,220,151,.12); }
    .numstrip button.bad{ border-color: rgba(255,92,122,.45); background: rgba(255,92,122,.12); }
    .numstrip button.neutral{ border-color: rgba(255,255,255,.10); background: rgba(255,255,255,.05); }

    .modalback{
      position:fixed; inset:0; background: rgba(0,0,0,.55);
      display:none; align-items:center; justify-content:center; padding:16px; z-index: 50;
    }
    .modal{
      width:min(800px, 100%);
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
      border:1px solid var(--border); border-radius: 18px; box-shadow: 0 10px 25px rgba(0,0,0,.35); overflow:hidden;
    }
    .modal .mh{
      padding:14px 16px; border-bottom:1px solid var(--border);
      display:flex; justify-content:space-between; gap:10px; align-items:center;
    }
    .modal .mb{ padding:16px; color:var(--text); }
    .muted{ color: var(--muted); }
    .tiny{ font-size:12px; }
    .hr{ height:1px; background: var(--border); margin:12px 0; }

    .toast{
      position: fixed; right: 14px; bottom: 14px;
      padding: 10px 12px; border-radius: 12px;
      border:1px solid var(--border); background: rgba(0,0,0,.65);
      color: var(--text); box-shadow: 0 10px 25px rgba(0,0,0,.35);
      display:none; z-index: 60; font-size: 13px;
    }
  </style>

  <script src="bank.js"></script>
</head>

<body>
  <header>
    <div class="title">
      <h1>義務教育9年 5教科ランダム25問クイズ</h1>
      <span class="badge">問題バンク：各教科500問（合計2,500）</span>
      <span class="badge">難易度：基礎20%・標準50%・発展30%</span>
      <span class="badge">タグ：小/中・基礎/標準/発展で出題調整</span>
    </div>
    <div class="sub">
      公開リンクで誰でもプレイ可。提出後に全結果・解説・分析・五角形チャートを表示します。
      （※クライアント完結なので“答えをソースで見られる”点は仕様です。厳密な試験モードはサーバーが必要）
    </div>

    <div class="controls">
      <div class="controlbox">
        <div class="ct">出題範囲（学年タグ）</div>
        <div class="checks">
          <label><input type="checkbox" id="lvlE" checked> 小</label>
          <label><input type="checkbox" id="lvlJ" checked> 中</label>
        </div>
        <div class="muted tiny" style="margin-top:6px;">小・中のどちらかは必ずON（足りない場合は自動補完）。</div>
      </div>

      <div class="controlbox">
        <div class="ct">難易度（基礎/標準/発展）</div>
        <div class="checks">
          <label><input type="checkbox" id="dB" checked> 基礎</label>
          <label><input type="checkbox" id="dS" checked> 標準</label>
          <label><input type="checkbox" id="dA" checked> 発展</label>
        </div>
        <div class="muted tiny" style="margin-top:6px;">
          すべてONの場合、配分は<strong>基礎5・標準12・発展8</strong>（25問）に固定。OFFがある場合は成立優先で再配分します。
        </div>
      </div>
    </div>
  </header>

  <main>
    <section class="card">
      <div class="hd">
        <div class="meta">
          <span class="pill" id="seedPill">Seed: -</span>
          <span class="pill" id="timerPill">Time: 00:00</span>
          <span class="pill" id="progressPill">Answered: 0 / 25</span>
        </div>
        <div class="btnrow">
          <button class="ghost" id="btnNew">新しいクイズ</button>
          <button class="danger" id="btnReset">回答リセット</button>
          <button class="primary" id="btnSubmit">提出して採点</button>
        </div>
      </div>
      <div class="bd" id="quizRoot"></div>
    </section>

    <aside class="rightcol">
      <section class="card">
        <div class="hd">
          <div>
            <div style="font-weight:900">結果</div>
            <div class="muted tiny">提出後に表示（番号ボタンで解説）</div>
          </div>
          <div class="btnrow">
            <button id="btnCopy" disabled>結果をコピー</button>
          </div>
        </div>
        <div class="bd">
          <div class="resultgrid" id="kpiGrid">
            <div class="kpi"><div class="v">-</div><div class="k">総合スコア</div></div>
            <div class="kpi"><div class="v">-</div><div class="k">正答率</div></div>
            <div class="kpi"><div class="v">-</div><div class="k">平均回答時間</div></div>
            <div class="kpi"><div class="v">-</div><div class="k">弱点教科</div></div>
          </div>

          <div class="hr"></div>
          <canvas id="radar" height="220"></canvas>

          <div class="hr"></div>
          <div class="analysis" id="analysisBox">
            <b>提出すると</b>、ここに分析が出ます。
            <ul>
              <li>教科別：得点・傾向</li>
              <li>難易度別：得点（基礎/標準/発展）</li>
              <li>学年別：得点（小/中）</li>
            </ul>
          </div>

          <div class="hr"></div>
          <div>
            <div style="font-weight:900; margin-bottom:10px;">問題番号（クリックで解説）</div>
            <div class="numstrip" id="numStrip"></div>
          </div>
        </div>
      </section>
    </aside>
  </main>

  <div class="modalback" id="modalBack" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="mh">
        <div>
          <div id="modalTitle" style="font-weight:900">解説</div>
          <div class="muted tiny" id="modalSub">-</div>
        </div>
        <button class="ghost" id="btnCloseModal">閉じる</button>
      </div>
      <div class="mb" id="modalBody"></div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
// ===== エラー可視化（デバッグ） =====
window.addEventListener("error", (e) => {
  const msg = `JS Error: ${e.message}\n${e.filename}:${e.lineno}`;
  console.error(msg, e.error);
  alert(msg); // まずは確実に気づけるようalert
});
window.addEventListener("unhandledrejection", (e) => {
  const msg = `Promise Error: ${e.reason?.message || e.reason}`;
  console.error(msg, e.reason);
  alert(msg);
});

/* PWA */
if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => navigator.serviceWorker.register("./sw.js").catch(()=>{}));
}

/* Utils */
function mulberry32(seed){ let t = seed>>>0; return function(){ t += 0x6D2B79F5; let r = Math.imul(t ^ (t>>>15), 1|t); r ^= r + Math.imul(r ^ (r>>>7), 61|r); return ((r ^ (r>>>14))>>>0)/4294967296; }; }
function hashStringToSeed(str){ let h=2166136261>>>0; for(let i=0;i<str.length;i++){ h^=str.charCodeAt(i); h=Math.imul(h,16777619); } return h>>>0; }
function shuffle(arr, rng){ const a=arr.slice(); for(let i=a.length-1;i>0;i--){ const j=Math.floor(rng()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }
function fmtTime(sec){ const m=String(Math.floor(sec/60)).padStart(2,"0"); const s=String(sec%60).padStart(2,"0"); return `${m}:${s}`; }
function escapeHtml(s){ return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }
function toast(msg){
  const el=document.getElementById("toast");
  if (!el) return;
  el.textContent = msg;
  el.style.display="block";
  clearTimeout(toast._t);
  toast._t=setTimeout(()=> el.style.display="none", 1600);
}
function cryptoRandomId(){ const a=new Uint8Array(8); crypto.getRandomValues(a); return Array.from(a).map(b=>b.toString(16).padStart(2,"0")).join(""); }

/* ========= 合言葉ゲート（0217）ここから ========= */
(function passphraseGate(){
  const PASSPHRASE = "0217";
  const passed = sessionStorage.getItem("quiz_passed") === "1";

  function renderGate(){
    document.body.innerHTML = `
      <div style="max-width:760px;margin:70px auto;padding:18px;font-family:system-ui;color:#eaf0ff;">
        <div style="padding:18px;border:1px solid rgba(255,255,255,.12);border-radius:16px;background:rgba(0,0,0,.25);">
          <h2 style="margin:0 0 10px;">合言葉が必要です</h2>
          <p style="margin:0 0 14px;color:rgba(234,240,255,.75);">
            このクイズは合言葉を知っている人だけ遊べます。
          </p>

          <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
            <input id="pw" inputmode="numeric" placeholder="合言葉（4桁）"
                   style="padding:12px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.12);
                          background:rgba(255,255,255,.06);color:#eaf0ff;font-size:16px;outline:none;">
            <button id="enter"
                    style="padding:12px 14px;border-radius:12px;border:1px solid rgba(122,167,255,.45);
                           background:rgba(122,167,255,.18);color:#eaf0ff;font-weight:800;cursor:pointer;">
              入室
            </button>
          </div>

          <div id="msg" style="margin-top:10px;color:rgba(255,200,87,.95);display:none;">
            合言葉が違います。
          </div>

          <hr style="border:none;height:1px;background:rgba(255,255,255,.10);margin:16px 0;">
          <div style="font-size:12px;color:rgba(234,240,255,.65);">
            ※合言葉方式のため、合言葉が共有されると入室できます（サーバー認証なし）。<br>
            ※同じタブでは通過状態を保持（タブを閉じると再入力）。
          </div>
        </div>
      </div>
    `;
    const input = document.getElementById("pw");
    const btn = document.getElementById("enter");
    const msg = document.getElementById("msg");

    function tryEnter(){
      if (input.value === PASSPHRASE){
        sessionStorage.setItem("quiz_passed","1");
        location.reload();
      } else {
        msg.style.display = "block";
        input.select();
      }
    }
    btn.addEventListener("click", tryEnter);
    input.addEventListener("keydown", (e)=>{ if(e.key==="Enter") tryEnter(); });
    input.focus();
  }

  if (!passed){
    renderGate();
    // ここで以降の初期化を止める（エラーに見せないためreturn）
    window.__QUIZ_BLOCKED__ = true;
  }
})();
/* ========= 合言葉ゲート（0217）ここまで ========= */

const SUBJECTS = ["国語","数学","英語","理科","社会"];
const DIFFS = ["基礎","標準","発展"];
const LEVELS = ["小","中"];

let state = {
  seedStr:"", seed:0, rng:null,
  bank:[], questions:[],
  answers:new Map(),
  perQuestionTimer:new Map(),
  startedAtMs:0, elapsedSec:0, timerHandle:null,
  submitted:false,
  chart:null
};

function destroyChart(){ if(state.chart){ state.chart.destroy(); state.chart=null; } }

function getSelectedFilters(){
  const lvls = [];
  if (document.getElementById("lvlE").checked) lvls.push("小");
  if (document.getElementById("lvlJ").checked) lvls.push("中");
  const diffs = [];
  if (document.getElementById("dB").checked) diffs.push("基礎");
  if (document.getElementById("dS").checked) diffs.push("標準");
  if (document.getElementById("dA").checked) diffs.push("発展");
  return { lvls, diffs };
}

/** 25問に対して2:5:3近似整数：基礎5 / 標準12 / 発展8 */
function plannedDifficultyCounts(total=25){
  return { "基礎":5, "標準":12, "発展":8 };
}

/**
 * 学年・難易度フィルタを適用して問題抽選
 * 足りない場合は段階的に緩和して「必ず成立」
 */
function pickQuestionsFromBank(bank, rng, filters){
  if (filters.lvls.length === 0){ filters.lvls = ["小","中"]; toast("学年が全OFFだったので小＋中で出題します"); }
  if (filters.diffs.length === 0){ filters.diffs = ["基礎","標準","発展"]; toast("難易度が全OFFだったので基礎＋標準＋発展で出題します"); }

  const strict = (filters.diffs.length === 3);

  // 全体配分を満たすため、教科ごと配分を混ぜる（合計が5/12/8になる）
  const subjOrder = shuffle(SUBJECTS, rng);
  const typeA = new Set(subjOrder.slice(0,2)); // 2教科: 1基礎・3標準・1発展
  const perSubjPlan = {};
  for (const s of SUBJECTS){
    perSubjPlan[s] = typeA.has(s)
      ? { "基礎":1, "標準":3, "発展":1 }
      : { "基礎":1, "標準":2, "発展":2 };
  }

  function normalizePlan(plan){
    if (strict) return plan;
    const allowed = new Set(filters.diffs);
    let total=0;
    const p = { "基礎":0,"標準":0,"発展":0 };
    for (const d of DIFFS){
      if (allowed.has(d)){ p[d]=plan[d]; total += p[d]; }
    }
    if (total===0) return plan;

    const target = 5;
    const raw = DIFFS.map(d => ({d, v: allowed.has(d) ? (plan[d]/total)*target : 0}));
    let acc = 0;
    for (const x of raw){ x.f = Math.floor(x.v); acc += x.f; }
    let remain = target - acc;
    raw.sort((a,b)=> (b.v-b.f) - (a.v-a.f));
    for (let i=0;i<raw.length && remain>0;i++){
      if (raw[i].v>0){ raw[i].f += 1; remain--; }
    }
    const out = { "基礎":0,"標準":0,"発展":0 };
    for (const x of raw){ out[x.d]=x.f; }
    const sum = out["基礎"]+out["標準"]+out["発展"];
    if (sum<5){
      const d = allowed.has("標準") ? "標準" : (allowed.has("基礎") ? "基礎" : "発展");
      out[d] += (5-sum);
    }
    return out;
  }

  function poolFor(sub, diff, lvls){
    return bank.filter(q => q.sub===sub && q.diff===diff && lvls.includes(q.level));
  }
  function relaxedPool(sub, diff){
    const p1 = bank.filter(q => q.sub===sub && q.diff===diff);
    const p2 = bank.filter(q => q.sub===sub && filters.lvls.includes(q.level));
    const p3 = bank.filter(q => q.sub===sub);
    return { p1, p2, p3 };
  }

  const picked = [];
  const usedKeys = new Set();

  for (const sub of SUBJECTS){
    const plan = normalizePlan(perSubjPlan[sub]);
    for (const diff of DIFFS){
      const need = plan[diff];
      if (need<=0) continue;

      let pool = poolFor(sub, diff, filters.lvls);
      pool = pool.filter(q => !usedKeys.has(q.key));

      if (pool.length < need){
        const {p1,p2,p3} = relaxedPool(sub, diff);
        let merged = pool.slice();

        const addFrom = (arr)=>{
          for (const q of arr){
            if (merged.length >= need) break;
            if (!usedKeys.has(q.key)) merged.push(q);
          }
        };
        addFrom(p1);
        addFrom(p2);
        addFrom(p3);
        pool = merged;
      }

      if (pool.length < need){
        const fallback = bank.filter(q=>q.sub===sub && !usedKeys.has(q.key));
        toast(`プール不足：${sub}/${diff} が不足したため、同教科から補填しました`);
        pool = fallback;
      }

      const chosen = shuffle(pool, rng).slice(0, need);
      for (const q of chosen){
        usedKeys.add(q.key);
        picked.push({
          id: cryptoRandomId(),
          sub: q.sub, level: q.level, diff: q.diff,
          q: q.q, c: q.c.slice(), a: q.a, exp: q.exp,
          key: q.key
        });
      }
    }
  }

  return shuffle(picked, rng).slice(0, 25).map((x,i)=> ({...x, no:i+1}));
}

function buildQuiz(){
  const filters = getSelectedFilters();
  if (!state.bank.length){
    state.bank = window.SchoolQuizBank.buildAll(500);
  }

  const seedStr = `${Date.now()}-${Math.random().toString(16).slice(2)}`;
  const seed = hashStringToSeed(seedStr);
  const rng = mulberry32(seed);

  const questions = pickQuestionsFromBank(state.bank, rng, filters);

  state.seedStr = seedStr;
  state.seed = seed;
  state.rng = rng;
  state.questions = questions;
  state.answers = new Map();
  state.perQuestionTimer = new Map();
  state.startedAtMs = Date.now();
  state.elapsedSec = 0;
  state.submitted = false;

  document.getElementById("seedPill").textContent = `Seed: ${seed.toString(16)}`;
  document.getElementById("btnSubmit").disabled = true;
  document.getElementById("btnCopy").disabled = true;

  setKpisPlaceholders();
  renderQuestions();
  renderNumStrip();
  renderAnalysisPlaceholder();
  destroyChart();
  startGlobalTimer();
  updateProgress();
}

function startGlobalTimer(){
  if (state.timerHandle) clearInterval(state.timerHandle);
  state.timerHandle = setInterval(()=>{
    state.elapsedSec = Math.floor((Date.now() - state.startedAtMs)/1000);
    document.getElementById("timerPill").textContent = `Time: ${fmtTime(state.elapsedSec)}`;
  }, 250);
}

function renderQuestions(){
  const root = document.getElementById("quizRoot");
  root.innerHTML = "";

  for (const item of state.questions){
    const qEl = document.createElement("div");
    qEl.className = "q";
    qEl.dataset.qid = item.id;

    const top = document.createElement("div");
    top.className = "qtop";

    const left = document.createElement("div");
    left.innerHTML = `
      <div class="qtitle">Q${item.no}. ${escapeHtml(item.q)}</div>
      <div class="qmeta">
        <span class="tag">${escapeHtml(item.sub)}</span>
        <span class="tag">${escapeHtml(item.level)}</span>
        <span class="tag">${escapeHtml(item.diff)}</span>
      </div>
    `;

    const right = document.createElement("div");
    const statusTag = document.createElement("span");
    statusTag.className = "tag warn";
    statusTag.textContent = "未採点";
    statusTag.id = `status-${item.id}`;
    const ansTag = document.createElement("span");
    ansTag.className = "tag";
    ansTag.textContent = "未回答";
    ansTag.id = `ans-${item.id}`;
    right.appendChild(statusTag);
    right.appendChild(ansTag);

    top.appendChild(left);
    top.appendChild(right);

    const choices = document.createElement("div");
    choices.className = "choices";

    item.c.forEach((text, idx)=>{
      const label = document.createElement("label");
      label.className = "choice";
      label.innerHTML = `
        <input type="radio" name="q-${item.id}" value="${idx}" ${state.submitted ? "disabled": ""}/>
        <div><b>${String.fromCharCode(65+idx)}.</b> ${escapeHtml(text)}</div>
      `;
      label.addEventListener("click", ()=>{
        if (state.submitted) return;
        if (!state.perQuestionTimer.has(item.id)) state.perQuestionTimer.set(item.id, Date.now());

        state.answers.set(item.id, { choiceIndex: idx, timeSpentSec: 0 });

        const box = root.querySelector(\`.q[data-qid="\${item.id}"]\`);
        box.querySelectorAll(".choice").forEach(ch => ch.classList.remove("selected"));
        label.classList.add("selected");
        document.getElementById(\`ans-\${item.id}\`).textContent = `回答: ${String.fromCharCode(65+idx)}`;

        updateProgress();
      });
      choices.appendChild(label);
    });

    qEl.appendChild(top);
    qEl.appendChild(choices);
    root.appendChild(qEl);
  }
}

function updateProgress(){
  const answered = state.answers.size;
  document.getElementById("progressPill").textContent = `Answered: ${answered} / 25`;
  document.getElementById("btnSubmit").disabled = (answered < 25) || state.submitted;
  if (!state.submitted) renderNumStrip();
}

function renderNumStrip(){
  const strip = document.getElementById("numStrip");
  strip.innerHTML = "";
  for (const item of state.questions){
    const btn = document.createElement("button");
    btn.textContent = item.no;
    btn.className = "neutral";
    btn.disabled = !state.submitted;
    if (state.submitted){
      const ok = isQuestionCorrect(item.id);
      btn.className = ok ? "good" : "bad";
    }
    btn.addEventListener("click", ()=>{ if (state.submitted) openExplanation(item.no); });
    strip.appendChild(btn);
  }
}

function openExplanation(questionNo){
  const item = state.questions.find(x=>x.no===questionNo);
  if (!item) return;

  const ans = state.answers.get(item.id);
  const yourIdx = ans?.choiceIndex;
  const correctIdx = item.a;
  const your = (yourIdx===undefined) ? "未回答" : `${String.fromCharCode(65+yourIdx)}. ${item.c[yourIdx]}`;
  const corr = `${String.fromCharCode(65+correctIdx)}. ${item.c[correctIdx]}`;
  const ok = (yourIdx === correctIdx);

  document.getElementById("modalSub").textContent = `Q${item.no} / ${item.sub} / ${item.level} / ${item.diff} / ${ok ? "正解" : "不正解"}`;
  document.getElementById("modalBody").innerHTML = `
    <div style="font-weight:900; font-size:16px;">${escapeHtml(item.q)}</div>
    <div class="hr"></div>
    <div><b>あなたの回答：</b> ${escapeHtml(your)}</div>
    <div><b>正解：</b> ${escapeHtml(corr)}</div>
    <div class="hr"></div>
    <div><b>解説：</b><br>${escapeHtml(item.exp)}</div>
    <div class="hr"></div>
    <div class="muted tiny">※提出後のみ閲覧可</div>
  `;
  const back = document.getElementById("modalBack");
  back.style.display="flex";
  back.setAttribute("aria-hidden","false");
}
function closeModal(){
  const back = document.getElementById("modalBack");
  back.style.display="none";
  back.setAttribute("aria-hidden","true");
}

function isQuestionCorrect(qid){
  const q = state.questions.find(x=>x.id===qid);
  const a = state.answers.get(qid);
  return a && a.choiceIndex === q.a;
}
function computeTimes(){
  const now = Date.now();
  for (const q of state.questions){
    const started = state.perQuestionTimer.get(q.id);
    const ans = state.answers.get(q.id);
    if (!ans) continue;
    ans.timeSpentSec = started ? Math.max(0, Math.round((now-started)/1000)) : 0;
  }
}

function submit(){
  if (state.submitted) return;
  if (state.answers.size < 25){ toast("全問回答してから提出してください"); return; }
  computeTimes();
  state.submitted = true;
  document.getElementById("btnCopy").disabled = false;

  const root = document.getElementById("quizRoot");
  for (const item of state.questions){
    const box = root.querySelector(`.q[data-qid="${item.id}"]`);
    const choices = Array.from(box.querySelectorAll(".choice"));
    const radios = Array.from(box.querySelectorAll("input[type=radio]"));
    radios.forEach(r=> r.disabled = true);

    const ans = state.answers.get(item.id);
    const chosen = ans.choiceIndex;
    const correct = item.a;

    choices.forEach((ch, idx)=>{
      ch.classList.remove("selected");
      if (idx === chosen) ch.classList.add("selected");
      if (idx === correct) ch.classList.add("correct");
      if (idx === chosen && chosen !== correct) ch.classList.add("wrong");
    });

    const ok = (chosen === correct);
    const st = document.getElementById(`status-${item.id}`);
    st.className = `tag ${ok ? "good" : "bad"}`;
    st.textContent = ok ? "正解" : "不正解";
  }

  renderNumStrip();
  renderResults();
  document.getElementById("btnSubmit").disabled = true;
}

function setKpisPlaceholders(){
  document.getElementById("kpiGrid").innerHTML = `
    <div class="kpi"><div class="v">-</div><div class="k">総合スコア</div></div>
    <div class="kpi"><div class="v">-</div><div class="k">正答率</div></div>
    <div class="kpi"><div class="v">-</div><div class="k">平均回答時間</div></div>
    <div class="kpi"><div class="v">-</div><div class="k">弱点教科</div></div>
  `;
}
function renderAnalysisPlaceholder(){
  document.getElementById("analysisBox").innerHTML = `
    <b>提出すると</b>、ここに分析が出ます。
    <ul>
      <li>教科別：得点・傾向</li>
      <li>難易度別：得点（基礎/標準/発展）</li>
      <li>学年別：得点（小/中）</li>
    </ul>
    <div class="muted tiny">※番号ボタンで解説は提出後に表示</div>
  `;
}

function drawRadar(scores){
  const ctx = document.getElementById("radar");
  destroyChart();
  if (!window.Chart){
    toast("Chart.jsが読み込めないため、チャートを省略します");
    return;
  }
  state.chart = new Chart(ctx, {
    type: "radar",
    data: { labels: SUBJECTS, datasets: [{ label: "得点（各5点満点）", data: scores, fill: true, borderWidth: 2, pointRadius: 3 }] },
    options: {
      responsive:true,
      scales:{ r:{ min:0, max:5, ticks:{stepSize:1}, grid:{circular:false}, pointLabels:{ font:{ size:12, weight:"600" } } } },
      plugins:{ legend:{display:false}, tooltip:{ callbacks:{ label:(ctx)=>` ${ctx.raw}/5` } } }
    }
  });
}

function renderResults(){
  const bySub = {}; SUBJECTS.forEach(s=> bySub[s]={correct:0,total:0,timeSum:0});
  const byDiff = {}; DIFFS.forEach(d=> byDiff[d]={correct:0,total:0});
  const byLvl = {}; LEVELS.forEach(l=> byLvl[l]={correct:0,total:0});

  let totalCorrect=0, totalTime=0;

  for (const q of state.questions){
    const ans = state.answers.get(q.id);
    const ok = ans.choiceIndex === q.a;

    bySub[q.sub].total += 1;
    bySub[q.sub].timeSum += ans.timeSpentSec;
    byDiff[q.diff].total += 1;
    byLvl[q.level].total += 1;

    if (ok){
      bySub[q.sub].correct += 1;
      byDiff[q.diff].correct += 1;
      byLvl[q.level].correct += 1;
      totalCorrect++;
    }
    totalTime += ans.timeSpentSec;
  }

  const pct = Math.round((totalCorrect/25)*100);
  const avgTime = Math.round(totalTime/25);
  const weakest = SUBJECTS.slice().sort((a,b)=> (bySub[a].correct - bySub[b].correct))[0];
  const strength = SUBJECTS.slice().sort((a,b)=> (bySub[b].correct - bySub[a].correct))[0];

  const grid = document.getElementById("kpiGrid");
  grid.innerHTML = "";
  [
    {v:`${totalCorrect} / 25`, k:"総合スコア"},
    {v:`${pct}%`, k:"正答率"},
    {v:`${avgTime}秒/問`, k:"平均回答時間"},
    {v:`${weakest}（${bySub[weakest].correct}/5）`, k:"弱点教科"},
  ].forEach(x=>{
    const el=document.createElement("div");
    el.className="kpi";
    el.innerHTML=`<div class="v">${escapeHtml(x.v)}</div><div class="k">${escapeHtml(x.k)}</div>`;
    grid.appendChild(el);
  });

  drawRadar(SUBJECTS.map(s=>bySub[s].correct));

  const subjLines = SUBJECTS.map(s=>{
    const c = bySub[s].correct;
    const t = Math.round(bySub[s].timeSum/5);
    const level = c>=4 ? "強い" : c===3 ? "普通" : "要強化";
    return `・${s}: ${c}/5（${level}） / 平均 ${t}秒`;
  }).join("\n");

  const diffLines = DIFFS.map(d=>{
    const c = byDiff[d].correct;
    const t = byDiff[d].total;
    return `・${d}: ${c}/${t}`;
  }).join("\n");

  const lvlLines = LEVELS.map(l=>{
    const c = byLvl[l].correct;
    const t = byLvl[l].total;
    return `・${l}: ${c}/${t}`;
  }).join("\n");

  const next = [];
  next.push(`強み：${strength}は維持。弱点：${weakest}は“間違いの型”を1つずつ潰すのが最短。`);
  next.push(byDiff["発展"].total>0 && (byDiff["発展"].correct/byDiff["発展"].total)<0.5
    ? "発展が弱い：解説を読んだら“同じ型をもう1問”が効きます。"
    : "発展も戦えている：次は時間短縮に寄せると安定します。"
  );

  document.getElementById("analysisBox").innerHTML = `
    <b>分析サマリ</b><br>
    強み：<b>${escapeHtml(strength)}</b> ／ 弱点：<b>${escapeHtml(weakest)}</b><br>
    <div class="hr"></div>
    <b>教科別</b>
    <pre style="margin:8px 0 0; white-space:pre-wrap; color: var(--muted);">${escapeHtml(subjLines)}</pre>
    <div class="hr"></div>
    <b>難易度別</b>
    <pre style="margin:8px 0 0; white-space:pre-wrap; color: var(--muted);">${escapeHtml(diffLines)}</pre>
    <div class="hr"></div>
    <b>学年別</b>
    <pre style="margin:8px 0 0; white-space:pre-wrap; color: var(--muted);">${escapeHtml(lvlLines)}</pre>
    <div class="hr"></div>
    <b>次アクション</b>
    <ul>${next.map(x=>`<li>${escapeHtml(x)}</li>`).join("")}</ul>
  `;
}

function buildResultText(){
  const lines = [];
  lines.push("【義務教育9年 5教科ランダム25問 結果】");
  lines.push(`Seed: ${state.seed.toString(16)}`);
  lines.push(`Time: ${fmtTime(state.elapsedSec)}`);

  let totalCorrect=0, totalTime=0;
  const bySub = {}; SUBJECTS.forEach(s=>bySub[s]={c:0});
  const byDiff = {}; DIFFS.forEach(d=>byDiff[d]={c:0,t:0});
  const byLvl = {}; LEVELS.forEach(l=>byLvl[l]={c:0,t:0});

  for (const q of state.questions){
    const ans = state.answers.get(q.id);
    const ok = ans.choiceIndex === q.a;
    if (ok){ totalCorrect++; bySub[q.sub].c++; byDiff[q.diff].c++; byLvl[q.level].c++; }
    byDiff[q.diff].t++; byLvl[q.level].t++;
    totalTime += ans.timeSpentSec;
  }

  const pct = Math.round((totalCorrect/25)*100);
  const avg = Math.round(totalTime/25);
  lines.push(`総合: ${totalCorrect}/25（${pct}%） / 平均 ${avg}秒/問`);
  SUBJECTS.forEach(s=> lines.push(`${s}: ${bySub[s].c}/5`));
  DIFFS.forEach(d=> lines.push(`${d}: ${byDiff[d].c}/${byDiff[d].t}`));
  LEVELS.forEach(l=> lines.push(`${l}: ${byLvl[l].c}/${byLvl[l].t}`));
  lines.push("");
  lines.push("【各問題（あなたの回答 / 正解）】");
  for (const q of state.questions){
    const ans = state.answers.get(q.id);
    const you = String.fromCharCode(65 + ans.choiceIndex);
    const corr = String.fromCharCode(65 + q.a);
    const ok = (ans.choiceIndex === q.a) ? "○" : "×";
    lines.push(`Q${q.no} ${q.sub}/${q.level}/${q.diff} ${ok} あなた:${you} 正解:${corr} - ${q.q}`);
  }
  return lines.join("\n");
}
async function copyResults(){
  const text = buildResultText();
  try{
    await navigator.clipboard.writeText(text);
    toast("結果をコピーしました");
  }catch{
    const ta=document.createElement("textarea");
    ta.value=text; ta.style.position="fixed"; ta.style.left="-9999px";
    document.body.appendChild(ta); ta.select(); document.execCommand("copy");
    document.body.removeChild(ta);
    toast("結果をコピーしました（互換モード）");
  }
}

function resetAnswers(){
  state.answers = new Map();
  state.perQuestionTimer = new Map();
  state.submitted = false;
  document.getElementById("btnCopy").disabled = true;
  setKpisPlaceholders();
  renderAnalysisPlaceholder();
  destroyChart();
  renderQuestions();
  renderNumStrip();
  updateProgress();
  toast("回答をリセットしました");
}

/* Events */
function wireEvents(){
  document.getElementById("btnNew").addEventListener("click", buildQuiz);
  document.getElementById("btnReset").addEventListener("click", resetAnswers);
  document.getElementById("btnSubmit").addEventListener("click", submit);
  document.getElementById("btnCopy").addEventListener("click", copyResults);
  document.getElementById("btnCloseModal").addEventListener("click", closeModal);
  document.getElementById("modalBack").addEventListener("click", (e)=>{ if (e.target.id==="modalBack") closeModal(); });
  document.addEventListener("keydown", (e)=>{ if (e.key==="Escape") closeModal(); });

  ["lvlE","lvlJ","dB","dS","dA"].forEach(id=>{
    document.getElementById(id).addEventListener("change", ()=>{
      toast("設定を変更しました。『新しいクイズ』で反映されます。");
    });
  });
}

/* Start */
if (!window.__QUIZ_BLOCKED__) {
  wireEvents();
  buildQuiz();
}
</script>
</body>
</html>

